// Dictionnaire de traductions complet
const translations = {
    fr: {
        title: "G√©n√©rateur de Playlists de No√´l",
        subtitle: "Trouvez la playlist parfaite pour vos f√™tes ‚ú®",
        languageLabel: "üåç Langue :",
        regionLabel: "üìç R√©gion :",
        platformTitle: "Choisissez votre plateforme",
        moodTitle: "Quelle ambiance pour vos f√™tes ?",
        moodSubtitle: "S√©lectionnez jusqu'√† 3 ambiances",
        generateBtn: "G√©n√©rer mes playlists",
        loadingText: "G√©n√©ration en cours...",
        errorText: "Erreur lors de la g√©n√©ration des playlists",
        noPlaylistsText: "Aucune playlist trouv√©e pour ces crit√®res",
        playlistsFoundText: "playlists trouv√©es",
        trackText: "pistes",
        byText: "par",
        regions: {
            FR: "üá´üá∑ France",
            US: "üá∫üá∏ √âtats-Unis",
            UK: "üá¨üáß Royaume-Uni",
            ES: "üá™üá∏ Espagne",
            DE: "üá©üá™ Allemagne",
            CA: "üá®üá¶ Canada"
        },
        moods: {
            traditional: {
                name: "Traditionnel",
                desc: "Classiques de No√´l intemporels"
            },
            family: {
                name: "Familial",
                desc: "Pour toute la famille"
            },
            jazzy: {
                name: "Jazz",
                desc: "Swing et standards jazz"
            },
            modern: {
                name: "Moderne",
                desc: "Pop et rock contemporain"
            },
            romantic: {
                name: "Romantique",
                desc: "Ballades et ambiance intime"
            },
            party: {
                name: "F√™te",
                desc: "Rythmes entra√Ænants"
            },
            cozy: {
                name: "Cosy",
                desc: "Atmosph√®re chaleureuse"
            },
            international: {
                name: "International",
                desc: "No√´l du monde entier"
            }
        }
    },
    en: {
        title: "Christmas Playlist Generator",
        subtitle: "Find the perfect playlist for your holidays ‚ú®",
        languageLabel: "üåç Language:",
        regionLabel: "üìç Region:",
        platformTitle: "Choose your platform",
        moodTitle: "What's your holiday vibe?",
        moodSubtitle: "Select up to 3 moods",
        generateBtn: "Generate my playlists",
        loadingText: "Generating...",
        errorText: "Error generating playlists",
        noPlaylistsText: "No playlists found for these criteria",
        playlistsFoundText: "playlists found",
        trackText: "tracks",
        byText: "by",
        regions: {
            FR: "üá´üá∑ France",
            US: "üá∫üá∏ United States",
            UK: "üá¨üáß United Kingdom",
            ES: "üá™üá∏ Spain",
            DE: "üá©üá™ Germany",
            CA: "üá®üá¶ Canada"
        },
        moods: {
            traditional: {
                name: "Traditional",
                desc: "Timeless Christmas classics"
            },
            family: {
                name: "Family",
                desc: "Perfect for the whole family"
            },
            jazzy: {
                name: "Jazz",
                desc: "Swing and jazz standards"
            },
            modern: {
                name: "Modern",
                desc: "Contemporary pop and rock"
            },
            romantic: {
                name: "Romantic",
                desc: "Ballads and intimate vibes"
            },
            party: {
                name: "Party",
                desc: "Upbeat and energetic"
            },
            cozy: {
                name: "Cozy",
                desc: "Warm and peaceful atmosphere"
            },
            international: {
                name: "International",
                desc: "Christmas around the world"
            }
        }
    },
    es: {
        title: "Generador de Listas Navide√±as",
        subtitle: "Encuentra la lista perfecta para tus fiestas ‚ú®",
        languageLabel: "üåç Idioma:",
        regionLabel: "üìç Regi√≥n:",
        platformTitle: "Elige tu plataforma",
        moodTitle: "¬øCu√°l es tu ambiente navide√±o?",
        moodSubtitle: "Selecciona hasta 3 ambientes",
        generateBtn: "Generar mis listas",
        loadingText: "Generando...",
        errorText: "Error generando listas",
        noPlaylistsText: "No se encontraron listas para estos criterios",
        playlistsFoundText: "listas encontradas",
        trackText: "pistas",
        byText: "por",
        regions: {
            FR: "üá´üá∑ Francia",
            US: "üá∫üá∏ Estados Unidos",
            UK: "üá¨üáß Reino Unido",
            ES: "üá™üá∏ Espa√±a",
            DE: "üá©üá™ Alemania",
            CA: "üá®üá¶ Canad√°"
        },
        moods: {
            traditional: {
                name: "Tradicional",
                desc: "Cl√°sicos navide√±os atemporales"
            },
            family: {
                name: "Familiar",
                desc: "Perfecto para toda la familia"
            },
            jazzy: {
                name: "Jazz",
                desc: "Swing y est√°ndares de jazz"
            },
            modern: {
                name: "Moderno",
                desc: "Pop y rock contempor√°neo"
            },
            romantic: {
                name: "Rom√°ntico",
                desc: "Baladas y ambiente √≠ntimo"
            },
            party: {
                name: "Fiesta",
                desc: "Ritmos alegres y energ√©ticos"
            },
            cozy: {
                name: "Acogedor",
                desc: "Ambiente c√°lido y tranquilo"
            },
            international: {
                name: "Internacional",
                desc: "Navidad alrededor del mundo"
            }
        }
    },
    de: {
        title: "Weihnachts-Playlist Generator",
        subtitle: "Finde die perfekte Playlist f√ºr deine Feiertage ‚ú®",
        languageLabel: "üåç Sprache:",
        regionLabel: "üìç Region:",
        platformTitle: "W√§hle deine Plattform",
        moodTitle: "Wie ist deine Weihnachtsstimmung?",
        moodSubtitle: "W√§hle bis zu 3 Stimmungen",
        generateBtn: "Meine Playlists generieren",
        loadingText: "Wird generiert...",
        errorText: "Fehler beim Generieren der Playlists",
        noPlaylistsText: "Keine Playlists f√ºr diese Kriterien gefunden",
        playlistsFoundText: "Playlists gefunden",
        trackText: "Titel",
        byText: "von",
        regions: {
            FR: "üá´üá∑ Frankreich",
            US: "üá∫üá∏ Vereinigte Staaten",
            UK: "üá¨üáß Vereinigtes K√∂nigreich",
            ES: "üá™üá∏ Spanien",
            DE: "üá©üá™ Deutschland",
            CA: "üá®üá¶ Kanada"
        },
        moods: {
            traditional: {
                name: "Traditionell",
                desc: "Zeitlose Weihnachtsklassiker"
            },
            family: {
                name: "Familie",
                desc: "Perfekt f√ºr die ganze Familie"
            },
            jazzy: {
                name: "Jazz",
                desc: "Swing und Jazz-Standards"
            },
            modern: {
                name: "Modern",
                desc: "Zeitgen√∂ssischer Pop und Rock"
            },
            romantic: {
                name: "Romantisch",
                desc: "Balladen und intime Stimmung"
            },
            party: {
                name: "Party",
                desc: "Schwungvoll und energiegeladen"
            },
            cozy: {
                name: "Gem√ºtlich",
                desc: "Warme und friedliche Atmosph√§re"
            },
            international: {
                name: "International",
                desc: "Weihnachten rund um die Welt"
            }
        }
    }
};

// State de l'application
const state = {
    selectedPlatform: null,
    selectedMoods: [],
    playlists: [],
    currentLanguage: 'fr',
    currentRegion: 'FR',
    isLoading: false
};

// Fonction pour obtenir la traduction
function t(key) {
    const keys = key.split('.');
    let value = translations[state.currentLanguage];
    
    for (const k of keys) {
        if (value && value[k] !== undefined) {
            value = value[k];
        } else {
            // Fallback vers l'anglais si la traduction n'existe pas
            value = translations.en;
            for (const k2 of keys) {
                if (value && value[k2] !== undefined) {
                    value = value[k2];
                } else {
                    return key; // Retourner la cl√© si aucune traduction trouv√©e
                }
            }
            break;
        }
    }
    
    return value;
}

// Fonction pour mettre √† jour l'interface avec les traductions
function updateTranslations() {
    // Titre de la page
    document.title = t('title');
    
    // Titre principal
    const mainTitle = document.querySelector('.hero h1');
    if (mainTitle) mainTitle.textContent = t('title');
    
    // Sous-titre
    const subtitle = document.querySelector('.hero .subtitle');
    if (subtitle) subtitle.textContent = t('subtitle');
    
    // Labels des s√©lecteurs
    const languageLabel = document.querySelector('.language-selector label');
    if (languageLabel) languageLabel.textContent = t('languageLabel');
    
    const regionLabel = document.querySelector('.region-selector label');
    if (regionLabel) regionLabel.textContent = t('regionLabel');
    
    // Titre de la section plateforme
    const platformTitle = document.querySelector('#platform-section h2');
    if (platformTitle) platformTitle.textContent = t('platformTitle');
    
    // Titre de la section ambiances
    const moodTitle = document.querySelector('#mood-section h2');
    if (moodTitle) moodTitle.textContent = t('moodTitle');
    
    // Sous-titre des ambiances
    const moodSubtitle = document.querySelector('#mood-section .section-subtitle');
    if (moodSubtitle) moodSubtitle.textContent = t('moodSubtitle');
    
    // Bouton de g√©n√©ration
    const generateBtn = document.querySelector('#generate-btn');
    if (generateBtn && !state.isLoading) {
        generateBtn.textContent = t('generateBtn');
    }
    
    // Mettre √† jour les options de r√©gion
    const regionSelect = document.getElementById('regionSelect');
    if (regionSelect) {
        const options = regionSelect.querySelectorAll('option');
        options.forEach(option => {
            const regionCode = option.value;
            if (t(`regions.${regionCode}`)) {
                option.textContent = t(`regions.${regionCode}`);
            }
        });
    }
    
    // Mettre √† jour les ambiances
    updateMoodCards();
}

// Fonction pour mettre √† jour les cartes d'ambiance
function updateMoodCards() {
    const moodCards = document.querySelectorAll('.mood-card');
    moodCards.forEach(card => {
        const moodType = card.dataset.mood;
        const nameElement = card.querySelector('.mood-name');
        const descElement = card.querySelector('.mood-desc');
        
        if (nameElement && t(`moods.${moodType}.name`)) {
            nameElement.textContent = t(`moods.${moodType}.name`);
        }
        if (descElement && t(`moods.${moodType}.desc`)) {
            descElement.textContent = t(`moods.${moodType}.desc`);
        }
    });
}

// Fonction pour d√©tecter la langue du navigateur
function detectBrowserLanguage() {
    const browserLang = navigator.language || navigator.userLanguage;
    const langCode = browserLang.split('-')[0].toLowerCase();
    
    // V√©rifier si la langue est support√©e
    if (translations[langCode]) {
        return langCode;
    }
    
    return 'fr'; // D√©faut
}

// Fonction pour d√©tecter la r√©gion du navigateur
function detectBrowserRegion() {
    const browserLang = navigator.language || navigator.userLanguage;
    const regionCode = browserLang.split('-')[1];
    
    if (regionCode) {
        const upperRegion = regionCode.toUpperCase();
        const supportedRegions = ['FR', 'US', 'UK', 'ES', 'DE', 'CA'];
        if (supportedRegions.includes(upperRegion)) {
            return upperRegion;
        }
    }
    
    return 'FR'; // D√©faut
}

// Initialisation des s√©lecteurs de langue et r√©gion
function initializeLanguageAndRegion() {
    // Auto-d√©tecter la langue et r√©gion
    state.currentLanguage = detectBrowserLanguage();
    state.currentRegion = detectBrowserRegion();
    
    // Mettre √† jour les s√©lecteurs
    const languageSelect = document.getElementById('languageSelect');
    const regionSelect = document.getElementById('regionSelect');
    
    if (languageSelect) {
        languageSelect.value = state.currentLanguage;
        languageSelect.addEventListener('change', (e) => {
            state.currentLanguage = e.target.value;
            updateTranslations();
        });
    }
    
    if (regionSelect) {
        regionSelect.value = state.currentRegion;
        regionSelect.addEventListener('change', (e) => {
            state.currentRegion = e.target.value;
        });
    }
    
    // Mettre √† jour l'interface
    updateTranslations();
}

// Gestion de la s√©lection des plateformes
function initializePlatformSelection() {
    const platformCards = document.querySelectorAll('.platform-card');
    platformCards.forEach(card => {
        card.addEventListener('click', () => {
            // Supprimer la classe selected de toutes les cartes
            platformCards.forEach(c => c.classList.remove('selected'));
            
            // Ajouter la classe selected √† la carte cliqu√©e
            card.classList.add('selected');
            
            // Mettre √† jour le state
            state.selectedPlatform = card.dataset.platform;
            
            // Afficher la section suivante
            const moodSection = document.getElementById('mood-section');
            if (moodSection) {
                moodSection.style.display = 'block';
                moodSection.scrollIntoView({ behavior: 'smooth' });
            }
        });
    });
}

// Gestion de la s√©lection des ambiances
function initializeMoodSelection() {
    const moodCards = document.querySelectorAll('.mood-card');
    moodCards.forEach(card => {
        card.addEventListener('click', () => {
            const mood = card.dataset.mood;
            
            if (state.selectedMoods.includes(mood)) {
                // D√©selectionner
                state.selectedMoods = state.selectedMoods.filter(m => m !== mood);
                card.classList.remove('selected');
            } else if (state.selectedMoods.length < 3) {
                // S√©lectionner (max 3)
                state.selectedMoods.push(mood);
                card.classList.add('selected');
            }
            
            // Afficher le bouton si au moins une ambiance est s√©lectionn√©e
            const generateBtn = document.getElementById('generate-btn');
            if (generateBtn) {
                if (state.selectedMoods.length > 0) {
                    generateBtn.style.display = 'block';
                    generateBtn.scrollIntoView({ behavior: 'smooth' });
                } else {
                    generateBtn.style.display = 'none';
                }
            }
        });
    });
}

// G√©n√©ration des playlists
async function generatePlaylists() {
    if (!state.selectedPlatform || state.selectedMoods.length === 0) {
        alert('Veuillez s√©lectionner une plateforme et au moins une ambiance');
        return;
    }

    const generateBtn = document.getElementById('generate-btn');
    const resultsSection = document.getElementById('results-section');
    
    // √âtat de chargement
    state.isLoading = true;
    generateBtn.textContent = t('loadingText');
    generateBtn.disabled = true;
    
    // Afficher la section r√©sultats
    resultsSection.style.display = 'block';
    resultsSection.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>${t('loadingText')}</p>
        </div>
    `;
    resultsSection.scrollIntoView({ behavior: 'smooth' });

    try {
        const response = await fetch('/api/playlists', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                platform: state.selectedPlatform,
                moods: state.selectedMoods,
                language: state.currentLanguage,
                region: state.currentRegion
            })
        });

        const data = await response.json();

        if (data.success && data.playlists && data.playlists.length > 0) {
            state.playlists = data.playlists;
            displayPlaylists(data.playlists);
        } else {
            resultsSection.innerHTML = `
                <div class="no-results">
                    <h3>üéµ ${t('noPlaylistsText')}</h3>
                    <p>Essayez avec d'autres crit√®res ou une autre plateforme</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erreur:', error);
        resultsSection.innerHTML = `
            <div class="error">
                <h3>‚ùå ${t('errorText')}</h3>
                <p>Veuillez r√©essayer dans quelques instants</p>
            </div>
        `;
    } finally {
        // Remettre le bouton en √©tat normal
        state.isLoading = false;
        generateBtn.textContent = t('generateBtn');
        generateBtn.disabled = false;
    }
}

// Affichage des playlists
function displayPlaylists(playlists) {
    const resultsSection = document.getElementById('results-section');
    
    const resultsHTML = `
        <div class="results-header">
            <h2>üéµ ${playlists.length} ${t('playlistsFoundText')}</h2>
        </div>
        <div class="playlists-grid">
            ${playlists.map(playlist => `
                <div class="playlist-card" data-mood="${playlist.mood}">
                    <div class="playlist-image">
                        <img src="${playlist.image}" alt="${playlist.name}" loading="lazy">
                        <div class="playlist-platform">
                            ${playlist.platform === 'spotify' ? 
                                '<img src="https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/spotify.svg" alt="Spotify">' : 
                                '<img src="https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/deezer.svg" alt="Deezer">'
                            }
                        </div>
                    </div>
                    <div class="playlist-info">
                        <h3 class="playlist-name">${playlist.name}</h3>
                        <p class="playlist-desc">${playlist.description || ''}</p>
                        <div class="playlist-meta">
                            <span class="track-count">${playlist.trackCount} ${t('trackText')}</span>
                            <span class="playlist-owner">${t('byText')} ${playlist.owner}</span>
                        </div>
                        <a href="${playlist.url}" target="_blank" rel="noopener" class="playlist-link">
                            √âcouter sur ${playlist.platform === 'spotify' ? 'Spotify' : 'Deezer'}
                        </a>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    resultsSection.innerHTML = resultsHTML;
}

// Initialisation de l'application
function initializeApp() {
    // Initialiser la langue et r√©gion
    initializeLanguageAndRegion();
    
    // Initialiser les s√©lections
    initializePlatformSelection();
    initializeMoodSelection();
    
    // Event listener pour le bouton de g√©n√©ration
    const generateBtn = document.getElementById('generate-btn');
    if (generateBtn) {
        generateBtn.addEventListener('click', generatePlaylists);
    }
}

// D√©marrer l'application quand le DOM est charg√©
document.addEventListener('DOMContentLoaded', initializeApp);
